<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Wastech</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/login.css">
  <link rel="shortcut icon" href="Favicon/favicon.ico" type="image/x-icon">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="content-wrapper">
      <div class="image-container">
        <img src="Imagens/logobranca.png" alt="Logo Wastech">
      </div>
      <div class="form-container">
        <div class="login-header">
          <h1>Bem-vindo de volta</h1>
          <p>Entre com sua conta para continuar</p>
        </div>
        <div class="login-form">
          <form id="loginForm">
            <div class="input-group">
              <label for="email">E-mail</label>
              <i class="fas fa-envelope"></i>
              <input type="email" id="email" placeholder="seu.email@exemplo.com" required>
            </div>
            <div class="input-group">
              <label for="password">Senha</label>
              <i class="fas fa-lock"></i>
              <input type="password" id="password" placeholder="••••••••" required>
              <span class="toggle-password" onclick="togglePassword()">
                <i class="fas fa-eye" id="eyeIcon"></i>
              </span>
            </div>
            <div class="options">
              <div class="remember">
                <input type="checkbox" id="remember">
                <label for="remember">Lembrar-me</label>
              </div>
              <a href="resetpass.html" class="forgot-password">Esqueceu a senha?</a>
            </div>
            
            <button type="submit" class="login-button" id="loginButton">Entrar</button>
            <div class="signup">
              Não tem uma conta? <a href="cadastro.html">Cadastre-se</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 WastTech - Todos os direitos reservados
  </footer>

  <style>
    /* Alert Styles */
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .alert.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCp2xHQUeMipoA44g_QyZ71dnaRHnpGJtQ",
      authDomain: "wastech-8d384.firebaseapp.com",
      projectId: "wastech-8d384",
      storageBucket: "wastech-8d384.appspot.com",
      messagingSenderId: "957838233480",
      appId: "1:957838233480:web:576ae21101e425ed0d343d",
      measurementId: "G-9N582ETX68"
    };

    // Inicialização do Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Função para mostrar feedback
    function showMessage(message, isSuccess = false) {
      // Remove alertas anteriores
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(alert => alert.remove());
      
      const alertBox = document.createElement('div');
      alertBox.className = isSuccess ? 'alert success' : 'alert error';
      alertBox.textContent = message;
      document.querySelector('.login-form').prepend(alertBox);
      setTimeout(() => alertBox.remove(), 5000);
    }

    // Função de login
    async function handleLogin(email, password) {
      try {
        // 1. Autentica o usuário
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // 2. Busca dados adicionais
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        
        if (!userDoc.exists) {
          await auth.signOut();
          throw { code: "auth/user-data-not-found" };
        }
        
        // 3. Lembrar usuário se solicitado
        if (document.getElementById('remember').checked) {
          localStorage.setItem('rememberedEmail', email);
        } else {
          localStorage.removeItem('rememberedEmail');
        }
        
        // 4. Login bem-sucedido
        localStorage.setItem('userData', JSON.stringify(userDoc.data()));
        showMessage('Login realizado com sucesso!', true);
        
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1500);
        
      } catch (error) {
        console.error("Erro no login:", error);
        
        const errorMessages = {
          "auth/invalid-email": "E-mail inválido",
          "auth/user-not-found": "E-mail não cadastrado",
          "auth/wrong-password": "Senha incorreta",
          "auth/too-many-requests": "Muitas tentativas. Tente novamente em alguns minutos.",
          "auth/invalid-login-credentials": "Credenciais inválidas. Verifique seu e-mail e senha.",
          "auth/user-data-not-found": "Conta incompleta. Por favor, cadastre-se novamente."
        };
        
        showMessage(errorMessages[error.code] || "Erro ao fazer login. Tente novamente.");
      }
    }

    // Evento de submit
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showMessage('Preencha todos os campos');
        return;
      }
      
      // Desabilita o botão para evitar múltiplas tentativas
      const submitButton = document.getElementById('loginButton');
      submitButton.disabled = true;
      submitButton.textContent = 'Entrando...';
      
      await handleLogin(email, password);
      
      // Reabilita o botão
      submitButton.disabled = false;
      submitButton.textContent = 'Entrar';
    });

    // Mostrar/ocultar senha
    function togglePassword() {
      const passwordInput = document.getElementById('password');
      const eyeIcon = document.getElementById('eyeIcon');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    }

    // Verificar se há usuário lembrado
    window.addEventListener('DOMContentLoaded', () => {
      const rememberedEmail = localStorage.getItem('rememberedEmail');
      if (rememberedEmail) {
        document.getElementById('email').value = rememberedEmail;
        document.getElementById('remember').checked = true;
      }
      
      // Verificar se veio de um reset de senha
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('from') === 'reset') {
        showMessage('Senha redefinida com sucesso! Faça login com sua nova senha.', true);
      }
    });
  </script>
</body>
</html>